{% extends 'base.html.twig' %}

{% block title %}{{ book ? book.title : 'Book Details' }} - RSYWX Library{% endblock %}

{% block body %}
<div class="container">
    {% if error is defined and error %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle"></i> {{ error }}
        </div>
        <div class="text-center mt-4">
            <a href="{{ path('books_search') }}" class="btn btn-primary">
                <i class="bi bi-search"></i>
                Search Books
            </a>
        </div>
    {% elseif book %}
        <div class="row">
            <!-- Book Details -->
            <div class="col-lg-6 order-lg-1 order-2 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                        <h4 class="mb-0"><i class="bi bi-info-circle"></i> 图书信息</h4>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="bi bi-printer"></i> 打印详情
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Title and Author -->
                        <div class="mb-4">
                            <h2 class="mb-2">{{ book.title }}</h2>
                            <p class="lead text-muted">
                                作者：【{{ book.region }}】{{ book.author }}
                                {% if book.translated and book.copyrighter %}
                                    | {{ book.copyrighter }}
                                {% endif %}
                            </p>
                        </div>

                        <!-- Price and Purchase Info -->
                        <div class="row mb-4">
                            <!-- First Row -->
                            <div class="col-sm-6 col-lg-4 mb-2">
                                <h6 class="text-muted mb-1">价格</h6>
                                <p class="mb-0"><strong>{{ book.formattedPrice }}</strong></p>
                            </div>
                            <div class="col-sm-6 col-lg-4 mb-2">
                                <h6 class="text-muted mb-1">购买日期</h6>
                                <p class="mb-0"><strong>{{ book.formattedPurchaseDate }}</strong></p>
                            </div>
                            <div class="col-sm-6 col-lg-4 mb-2">
                                <h6 class="text-muted mb-1">位置</h6>
                                <p class="mb-0"><span class="badge bg-warning text-dark">{{ book.location }}</span></p>
                            </div>
                            {% if book.totalVisits %}
                            <!-- Second Row -->
                            <div class="col-sm-6 col-lg-6 mb-2">
                                <h6 class="text-muted mb-1">访问次数</h6>
                                <p class="mb-0"><strong>{{ book.totalVisits }}</strong></p>
                            </div>
                            <div class="col-sm-6 col-lg-6 mb-2">
                                <h6 class="text-muted mb-1">最后访问</h6>
                                <p class="mb-0">
                                    {% if book.lastVisited %}
                                        <strong>{{ book.lastVisited|date('Y-m-d H:i') }}</strong>
                                    {% else %}
                                        <strong class="text-muted">从未访问</strong>
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Publishing Information -->
                        {% if book.publisherName or book.pubdate or book.printdate or book.isbn %}
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-building"></i> 出版信息</h6>
                        <div class="row">
                            {% if book.publisherName %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">出版社</h6>
                                <p class="mb-0">{{ book.publisherName }}</p>
                            </div>
                            {% endif %}
                            {% if book.placeName %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">购买地点</h6>
                                <p class="mb-0">{{ book.placeName }}</p>
                            </div>
                            {% endif %}
                            {% if book.pubdate %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">出版日期</h6>
                                <p class="mb-0">{{ book.pubdate|date('Y-m-d') }}</p>
                            </div>
                            {% endif %}
                            {% if book.printdate %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">印刷日期</h6>
                                <p class="mb-0">{{ book.printdate|date('Y-m-d') }}</p>
                            </div>
                            {% endif %}
                            {% if book.isbn %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">ISBN</h6>
                                <p class="mb-0">{{ book.isbn }}</p>
                            </div>
                            {% endif %}
                            {% if book.category %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">分类</h6>
                                <p class="mb-0">{{ book.category }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Physical Details -->
                        {% if book.ver or book.deco or book.page or book.kword %}
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-book"></i> 物理信息</h6>
                        <div class="row">
                            {% if book.ver %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">版本</h6>
                                <p class="mb-0">{{ book.ver }}</p>
                            </div>
                            {% endif %}
                            {% if book.deco %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">装帧</h6>
                                <p class="mb-0">{{ book.deco }}</p>
                            </div>
                            {% endif %}
                            {% if book.page %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">页数</h6>
                                <p class="mb-0">{{ book.page }} 页</p>
                            </div>
                            {% endif %}
                            {% if book.kword %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-muted mb-1">字数</h6>
                                <p class="mb-0">{{ book.kword }} 千字</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Introduction -->
                        {% if book.intro %}
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-chat-text"></i> 简介</h6>
                        <div class="alert alert-secondary">
                            <p class="mb-0">{{ book.intro }}</p>
                        </div>
                        {% endif %}

                        <!-- Tags -->
                        <hr>
                        <turbo-frame id="book-tags-{{ book.bookid }}" src="{{ path('book_tags_frame', {'bookId': book.bookid}) }}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0"><i class="bi bi-tags"></i> 标签</h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTagsModal">
                                    <i class="bi bi-plus-circle"></i> 添加标签
                                </button>
                            </div>
                            <div class="mb-3">
                                {% if book.tags is not empty %}
                                    {% for tag in book.tags %}
                                        <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">暂无标签</span>
                                {% endif %}
                            </div>
                        </turbo-frame>


                    </div>
                </div>
            </div>
            
            <!-- Book Cover -->
            <div class="col-lg-6 order-lg-2 order-1 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        {% if book.hasCover %}
                            <img src="/covers/{{ book.bookid }}.webp" alt="{{ book.title }}" 
                                 class="rounded shadow mx-auto d-block" style="width: 600px; max-width: 100%; height: auto;">
                        {% else %}
                            <div class="bg-secondary rounded d-flex align-items-center justify-content-center shadow mx-auto" 
                                 style="height: 300px; width: 100%; max-width: 250px;">
                                <i class="bi bi-book text-white" style="font-size: 4rem;"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Reviews in Right Column -->
                    {% if book.reviews is not empty %}
                    <div class="card-body border-top">
                        <h6 class="mb-3"><i class="bi bi-star"></i> 评论</h6>
                        {% for review in book.reviews %}
                        <div class="mb-3">
                            <div class="card border-light">
                                {% if review.feature %}
                                    <img src="{{ review.feature }}" class="card-img-top" alt="{{ review.title }}" style="height: 150px; object-fit: cover;">
                                {% else %}
                                    <img src="/images/default.webp" class="card-img-top" alt="Default" style="height: 150px; object-fit: cover;">
                                {% endif %}
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                            {% if review.uri %}
                                <h6 class="card-title mb-0 small"><a href="{{ review.uri }}" target="_blank" class="text-decoration-none" style="color: var(--text-primary);">{{ review.title }}</a></h6>
                            {% else %}
                                <h6 class="card-title mb-0 small" style="color: var(--text-primary);">{{ review.title }}</h6>
                            {% endif %}
                            {% if review.rating is defined %}
                            <div class="text-muted">
                                {% for i in 1..5 %}
                                    {% if i <= review.rating %}
                                        <i class="bi bi-star-fill small"></i>
                                    {% else %}
                                        <i class="bi bi-star small"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                                    {% if review.uri %}
                                        <small class="text-muted"><a href="{{ review.uri }}" target="_blank" class="text-decoration-none text-muted">{{ review.datein }}</a></small>
                                    {% else %}
                                        <small class="text-muted">{{ review.datein }}</small>
                                    {% endif %}
                                    {% if review.uri %}
                                        <br><a href="{{ review.uri }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">阅读全文</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
    {% endif %}
</div>

<!-- Add Tags Modal -->
<div class="modal fade" id="addTagsModal" tabindex="-1" aria-labelledby="addTagsModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTagsModalLabel">
                    <i class="bi bi-tags"></i> 添加标签
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTagsForm">
                    <div class="mb-3">
                        <label for="tagsInput" class="form-label">标签 (用空格分隔)</label>
                        <input type="text" class="form-control" id="tagsInput" name="tags" 
                               placeholder="例如: 小说 经典 文学" required>
                        <div class="form-text">请用空格分隔多个标签</div>
                    </div>
                    <div class="mb-3">
                        <h6>当前标签：</h6>
                        <div id="currentTags">
                            {% if book.tags is not empty %}
                                {% for tag in book.tags %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">暂无标签</span>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTagsBtn">
                    <i class="bi bi-check-circle"></i> 保存标签
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveTagsBtn = document.getElementById('saveTagsBtn');
    const tagsInput = document.getElementById('tagsInput');
    const modal = new bootstrap.Modal(document.getElementById('addTagsModal'));
    const bookId = '{{ book.bookid }}';

    saveTagsBtn.addEventListener('click', async function() {
        const tagsValue = tagsInput.value.trim();
        if (!tagsValue) {
            alert('请输入标签');
            return;
        }

        // Parse tags from space-separated string
        const tags = tagsValue.split(' ').map(tag => tag.trim()).filter(tag => tag.length > 0);
        
        if (tags.length === 0) {
            alert('请输入有效的标签');
            return;
        }

        try {
            saveTagsBtn.disabled = true;
            saveTagsBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';

            const response = await fetch(`/api/books/${bookId}/tags`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ tags: tags })
            });

            if (response.ok) {
                const result = await response.json();
                
                // Close modal
                modal.hide();
                
                // Reset form
                tagsInput.value = '';
                
                // Refresh the tags frame with cache-busting
                setTimeout(() => {
                    const tagsFrame = document.getElementById(`book-tags-${bookId}`);
                    if (tagsFrame) {
                        // Add refresh parameter to bypass API cache
                        const currentSrc = tagsFrame.getAttribute('src');
                        const separator = currentSrc.includes('?') ? '&' : '?';
                        tagsFrame.setAttribute('src', currentSrc + separator + 'refresh=1&t=' + Date.now());
                    }
                }, 500);
                
            } else {
                const error = await response.json();
                alert('保存失败：' + (error.message || '未知错误'));
            }
        } catch (error) {
            console.error('Error saving tags:', error);
            alert('保存失败：网络错误');
        } finally {
            saveTagsBtn.disabled = false;
            saveTagsBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存标签';
        }
    });

    // Reset form when modal is closed
    document.getElementById('addTagsModal').addEventListener('hidden.bs.modal', function() {
        // Reset form state
        tagsInput.value = '';
        saveTagsBtn.disabled = false;
        saveTagsBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存标签';
    });
});
</script>

{% endblock %}