{% extends 'base.html.twig' %}

{% block title %}
	{{ page_title ?? '访问记录' }}
	- RSYWX Library
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<!-- Chart.js CDN -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<h1>
					<i class="{{ page_icon ?? 'bi bi-clock-history' }}"></i>
					{{ page_title ?? '访问记录' }}
				</h1>
				<p class="lead">{{ page_description ?? '书籍访问记录和统计分析' }}</p>
			</div>
		</div>

		<!-- Main Content with Left Navigation and Right Data Panel -->
		<div class="row">
			<!-- Left Navigation Panel -->
			<div class="col-md-3">
				<div class="card h-100">
					<div class="card-header">
						<h5 class="mb-0">
							<i class="bi bi-list-ul"></i>
							数据视图
						</h5>
					</div>
					<div class="card-body p-0">
						<div class="list-group list-group-flush">
							<a href="#recent-visits" class="list-group-item list-group-item-action active" data-dataset="recent">
								<i class="bi bi-clock-history me-2"></i>
								最近访问记录
								<small class="text-muted d-block">看看大家最近在看啥书</small>
							</a>
							<a href="#popular-books" class="list-group-item list-group-item-action" data-dataset="popular">
								<i class="bi bi-star me-2"></i>
								热门书籍
								<small class="text-muted d-block">Popular Books</small>
							</a>
							<a href="#unpopular-books" class="list-group-item list-group-item-action" data-dataset="unpopular">
								<i class="bi bi-star-fill me-2"></i>
								冷门书籍
								<small class="text-muted d-block">Unpopular Books</small>
							</a>
							<a href="#visit-stats" class="list-group-item list-group-item-action" data-dataset="stats">
								<i class="bi bi-graph-up me-2"></i>
								访问统计
								<small class="text-muted d-block">Visit Statistics</small>
							</a>
							<a href="#time-analysis" class="list-group-item list-group-item-action" data-dataset="time">
								<i class="bi bi-calendar3 me-2"></i>
								时间分析
								<small class="text-muted d-block">Time Analysis</small>
							</a>
							<a href="#user-patterns" class="list-group-item list-group-item-action" data-dataset="patterns">
								<i class="bi bi-person-lines-fill me-2"></i>
								用户模式
								<small class="text-muted d-block">User Patterns</small>
							</a>
						</div>
					</div>
				</div>
			</div>

			<!-- Right Data Display Panel -->
			<div class="col-md-9">
				<div class="card h-100">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h5 class="mb-0" id="data-panel-title">
							<i class="bi bi-clock-history"></i>
							最近访问记录
						</h5>
					</div>
					<div class="card-body" id="data-content">
						{% if error is defined and error %}
							<div class="alert alert-danger" role="alert">
								<i class="bi bi-exclamation-triangle"></i>
								{{ error }}
							</div>
						{% else %}
							<!-- Default: Recent Visit Records -->
							<div id="recent-visits-content" class="data-panel active">
								<!-- Visit Statistics Summary -->
								{% if datasets.visit_history is defined and datasets.visit_history.period_info is defined %}
									<div class="row mb-4">
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ datasets.visit_history.period_info.total_visits }}</h5>
													<p class="card-text small text-muted">总访问次数</p>
												</div>
											</div>
										</div>
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ datasets.visit_history.period_info.total_days }}</h5>
													<p class="card-text small text-muted">统计天数</p>
												</div>
											</div>
										</div>
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ (datasets.visit_history.period_info.total_visits / datasets.visit_history.period_info.total_days)|round(1) }}</h5>
													<p class="card-text small text-muted">日均访问</p>
												</div>
											</div>
										</div>
									</div>
								{% endif %}
								
								<!-- Visit History Chart -->
								<div class="mb-4">
									<h5>过去30天访问统计</h5>
									<div class="chart-container" style="height: 300px;">
										<canvas id="visitHistoryChart"></canvas>
									</div>
								</div>
								
								{% if datasets.visit_history is not defined or datasets.visit_history.data is empty %}
									<div class="alert alert-info" role="alert">
										<i class="bi bi-info-circle"></i>
										暂无访问记录。开始浏览书籍后，访问记录将会显示在这里。
									</div>
								{% endif %}
							</div>

							<!-- Placeholder for other datasets -->
							<div id="popular-books-content" class="data-panel d-none">
								{% if datasets.popular_books is defined and datasets.popular_books.success and datasets.popular_books.data is not empty %}
									<div class="table-responsive">
										<table class="table table-hover">
											<thead class="table-light">
												<tr>
													<th scope="col">书名</th>
													<th scope="col">访问次数</th>
													<th scope="col">最后访问</th>
													<th scope="col">位置</th>
												</tr>
											</thead>
											<tbody>
												{% for book in datasets.popular_books.data %}
													<tr>
														<td>
															<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																{{ book.title }}
															</a>
														</td>
														<td>
															{% if book.totalVisits is defined and book.totalVisits %}
																{{ book.totalVisits|number_format }}
															{% else %}
																<span class="text-muted">-</span>
															{% endif %}
														</td>
														<td>
															{% if book.lastVisited is defined and book.lastVisited %}
																<small class="text-muted">
																	<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																</small>
															{% else %}
																<small class="text-muted">未访问</small>
															{% endif %}
														</td>
														<td>
															{% if book.location is defined and book.location %}
																<small class="text-muted">{{ book.location }}</small>
															{% else %}
																<small class="text-muted">未知位置</small>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-5">
										<i class="bi bi-star display-4 text-muted"></i>
										<h4 class="mt-3">热门书籍数据</h4>
										<p class="text-muted">暂无热门书籍数据，开始浏览书籍后数据将会显示在这里。</p>
									</div>
								{% endif %}
							</div>

							<div id="unpopular-books-content" class="data-panel d-none">
								{% if datasets.unpopular_books is defined and datasets.unpopular_books.success and datasets.unpopular_books.data is not empty %}
									<div class="table-responsive">
										<table class="table table-hover">
											<thead class="table-light">
												<tr>
													<th scope="col">书名</th>
													<th scope="col">访问次数</th>
													<th scope="col">最后访问</th>
													<th scope="col">位置</th>
												</tr>
											</thead>
											<tbody>
												{% for book in datasets.unpopular_books.data %}
													<tr>
														<td>
															<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																{{ book.title }}
															</a>
														</td>
														<td>
															{% if book.totalVisits is defined and book.totalVisits is not null %}
																{{ book.totalVisits|number_format }}
															{% else %}
																<span class="text-muted">0</span>
															{% endif %}
														</td>
														<td>
															{% if book.lastVisited is defined and book.lastVisited is not null %}
																<small class="text-muted">
																	<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																</small>
															{% else %}
																<small class="text-muted">未访问</small>
															{% endif %}
														</td>
														<td>
															{% if book.location is defined and book.location %}
																<small class="text-muted">{{ book.location }}</small>
															{% else %}
																<small class="text-muted">未知位置</small>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-5">
										<i class="bi bi-star-fill display-4 text-muted"></i>
										<h4 class="mt-3">冷门书籍数据</h4>
										<p class="text-muted">暂无冷门书籍数据，开始浏览书籍后数据将会显示在这里。</p>
									</div>
								{% endif %}
							</div>

							<div id="visit-stats-content" class="data-panel d-none">
								<div class="text-center py-5">
									<i class="bi bi-graph-up display-4 text-muted"></i>
									<h4 class="mt-3">访问统计数据</h4>
									<p class="text-muted">正在加载访问统计分析...</p>
								</div>
							</div>

							<div id="time-analysis-content" class="data-panel d-none">
								<div class="text-center py-5">
									<i class="bi bi-calendar3 display-4 text-muted"></i>
									<h4 class="mt-3">时间分析数据</h4>
									<p class="text-muted">正在加载时间分析报告...</p>
								</div>
							</div>

							<div id="user-patterns-content" class="data-panel d-none">
								<div class="text-center py-5">
									<i class="bi bi-person-lines-fill display-4 text-muted"></i>
									<h4 class="mt-3">用户模式数据</h4>
									<p class="text-muted">正在加载用户行为模式...</p>
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Chart.js Library -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	
	<!-- JavaScript for Panel Switching -->
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// Navigation panel switching
			const navItems = document.querySelectorAll('.list-group-item[data-dataset]');
			const dataPanels = document.querySelectorAll('.data-panel');
			const panelTitle = document.getElementById('data-panel-title');

			navItems.forEach(item => {
				item.addEventListener('click', function(e) {
					e.preventDefault();
					
					// Remove active class from all nav items
					navItems.forEach(nav => nav.classList.remove('active'));
					// Add active class to clicked item
					this.classList.add('active');
					
					// Hide all data panels
					dataPanels.forEach(panel => panel.classList.add('d-none'));
					dataPanels.forEach(panel => panel.classList.remove('active'));
					
					// Show selected panel
					const dataset = this.getAttribute('data-dataset');
					const targetPanel = document.getElementById(dataset === 'recent' ? 'recent-visits-content' : 
																dataset === 'popular' ? 'popular-books-content' :
																dataset === 'unpopular' ? 'unpopular-books-content' :
																dataset === 'stats' ? 'visit-stats-content' :
																dataset === 'time' ? 'time-analysis-content' :
																'user-patterns-content');
					
					if (targetPanel) {
						targetPanel.classList.remove('d-none');
						targetPanel.classList.add('active');
					}
					
					// Update panel title
					const icon = this.querySelector('i').className;
					const title = this.textContent.trim().split('\n')[0];
					panelTitle.innerHTML = `<i class="${icon}"></i> ${title}`;
				});
			});

			// View switching (table/cards)
			const viewButtons = document.querySelectorAll('[data-view]');
			viewButtons.forEach(button => {
				button.addEventListener('click', function() {
					const view = this.getAttribute('data-view');
					const tableView = document.getElementById('table-view');
					const cardsView = document.getElementById('cards-view');
					
					// Remove active class from all view buttons
					viewButtons.forEach(btn => btn.classList.remove('active'));
					this.classList.add('active');
					
					if (view === 'table') {
						tableView.classList.remove('d-none');
						cardsView.classList.add('d-none');
					} else {
						tableView.classList.add('d-none');
						cardsView.classList.remove('d-none');
					}
				});
			});

			// Chart initialization
			const chartElement = document.getElementById('visitHistoryChart');
			if (chartElement) {
				{% if datasets.visit_history.data is defined and datasets.visit_history.data is not empty %}
					const visitHistoryData = {{ datasets.visit_history.data|json_encode|raw }};
					
					// Process data for Chart.js
					const labels = [];
					const values = [];
					
					// Handle different API response formats
					if (Array.isArray(visitHistoryData)) {
						visitHistoryData.forEach(item => {
							if (item.date && item.visit_count !== undefined) {
								labels.push(item.date);
								values.push(item.visit_count);
							}
						});
					}

					new Chart(chartElement, {
						type: 'line',
						data: {
							labels: labels,
							datasets: [{
								label: '访问次数',
								data: values,
								borderColor: 'rgb(75, 192, 192)',
								backgroundColor: 'rgba(75, 192, 192, 0.2)',
								tension: 0.1
							}]
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							scales: {
								y: {
									beginAtZero: true
								}
							}
						}
					});
				{% else %}
					// Show placeholder chart for no data
					new Chart(chartElement, {
						type: 'line',
						data: {
							labels: ['无数据'],
							datasets: [{
								label: '访问次数',
								data: [0],
								borderColor: 'rgb(200, 200, 200)',
								backgroundColor: 'rgba(200, 200, 200, 0.2)',
							}]
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							scales: {
								y: {
									beginAtZero: true,
									max: 1
								}
							}
						}
					});
				{% endif %}
			}
		});
	</script>
{% endblock %}