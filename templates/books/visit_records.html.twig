{% extends 'base.html.twig' %}

{% block title %}
	{{ page_title ?? '访问记录' }}
	- RSYWX Library
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<!-- Chart.js CDN -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
	
	<script>
		let chartInitialized = false;

		function initializeChart() {
			if (chartInitialized) return;
			
			const canvas = document.getElementById('visitHistoryChart');
			if (!canvas) return;

			const ctx = canvas.getContext('2d');
			
			{% if datasets.visit_history.data is defined and datasets.visit_history.data is not empty %}
				const visitHistoryData = {{ datasets.visit_history.data|json_encode|raw }};
				const labels = visitHistoryData.map(item => item.date);
				const values = visitHistoryData.map(item => item.visit_count);

				if (labels.length === 0) {
					canvas.style.display = 'none';
					return;
				}

				new Chart(ctx, {
					type: 'line',
					data: {
						labels: labels,
						datasets: [{
							label: '访问次数',
							data: values,
							borderColor: 'rgb(75, 192, 192)',
							backgroundColor: 'rgba(75, 192, 192, 0.2)',
							tension: 0.1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								ticks: {
									stepSize: 1
								}
							}
						}
					}
				});
			{% else %}
				// Show 'no data' chart
				new Chart(ctx, {
					type: 'line',
					data: {
						labels: ['无数据'],
						datasets: [{
							label: '访问次数',
							data: [0],
							borderColor: 'rgb(75, 192, 192)',
							backgroundColor: 'rgba(75, 192, 192, 0.2)',
							tension: 0.1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								max: 1
							}
						}
					}
				});
			{% endif %}
			
			chartInitialized = true;
		}

		function initializeChartSystem() {
			// Check if Chart.js is loaded
			if (typeof Chart === 'undefined') {
				setTimeout(initializeChartSystem, 100);
				return;
			}

			// Check if DOM is ready
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initializeChartSystem);
				return;
			}

			// Check if the chart tab is already active
			const chartTab = document.querySelector('#recent-visits-tab');
			if (chartTab && chartTab.classList.contains('active')) {
				setTimeout(initializeChart, 100);
			}

			// Listen for tab show events
			document.addEventListener('shown.bs.tab', function(event) {
				if (event.target.id === 'recent-visits-tab') {
					setTimeout(initializeChart, 50);
				}
			});
		}

		// Start the initialization process
		initializeChartSystem();
	</script>
{% endblock %}

{% block body %}
	<div class="container mt-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<h1>
					<i class="{{ page_icon ?? 'bi bi-clock-history' }}"></i>
					{{ page_title ?? '访问记录' }}
				</h1>
				<p class="lead">{{ page_description ?? '书籍访问记录和统计分析' }}</p>
			</div>
		</div>

		<!-- Left Sidebar Navigation Layout -->
		<div class="row">
			<!-- Left Sidebar Navigation -->
			<div class="col-md-3">
				<div class="card">
					<div class="card-header">
						<h6 class="mb-0">
							<i class="bi bi-list-ul me-2"></i>导航菜单
						</h6>
					</div>
					<div class="list-group list-group-flush">
						<button class="list-group-item list-group-item-action active" id="recent-visits-tab" data-bs-toggle="tab" data-bs-target="#recent-visits" type="button" role="tab">
							<i class="bi bi-clock-history me-2"></i>最近访问记录
						</button>
						<button class="list-group-item list-group-item-action" id="popular-books-tab" data-bs-toggle="tab" data-bs-target="#popular-books" type="button" role="tab">
							<i class="bi bi-star me-2"></i>热门书籍
						</button>
						<button class="list-group-item list-group-item-action" id="unpopular-books-tab" data-bs-toggle="tab" data-bs-target="#unpopular-books" type="button" role="tab">
							<i class="bi bi-star-fill me-2"></i>冷门书籍
						</button>
						<button class="list-group-item list-group-item-action" id="recently-visited-tab" data-bs-toggle="tab" data-bs-target="#recently-visited" type="button" role="tab">
							<i class="bi bi-bookmark-heart me-2"></i>最近访问的书籍
						</button>
						<button class="list-group-item list-group-item-action" id="visit-stats-tab" data-bs-toggle="tab" data-bs-target="#visit-stats" type="button" role="tab">
							<i class="bi bi-book me-2"></i>被遗忘的书籍
						</button>
					</div>
				</div>
			</div>
			
			<!-- Main Content Area -->
			<div class="col-md-9">
				<div class="card">
					<div class="card-body">
						<div class="tab-content" id="visitTabsContent">
						{% if error is defined and error %}
							<div class="alert alert-danger" role="alert">
								<i class="bi bi-exclamation-triangle"></i>
								{{ error }}
							</div>
						{% else %}
							<!-- Tab Panes -->
							<div class="tab-pane fade show active" id="recent-visits" role="tabpanel">
								<!-- Visit Statistics Summary -->
								{% if datasets.visit_history is defined and datasets.visit_history.period_info is defined %}
									<div class="row mb-4">
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ datasets.visit_history.period_info.total_visits }}</h5>
													<p class="card-text small text-muted">总访问次数</p>
												</div>
											</div>
										</div>
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ datasets.visit_history.period_info.total_days }}</h5>
													<p class="card-text small text-muted">统计天数</p>
												</div>
											</div>
										</div>
										<div class="col-md-4">
											<div class="card text-center">
												<div class="card-body">
													<h5 class="card-title">{{ (datasets.visit_history.period_info.total_visits / datasets.visit_history.period_info.total_days)|round(1) }}</h5>
													<p class="card-text small text-muted">日均访问</p>
												</div>
											</div>
										</div>
									</div>
								{% endif %}
								
								<!-- Visit History Chart -->
								<div class="mb-4">
									<h5>过去30天访问统计</h5>
									<div class="chart-container" style="height: 300px;" id="chart-container">
										<canvas id="visitHistoryChart"></canvas>
									</div>
								</div>
								
								{% if datasets.visit_history is not defined or datasets.visit_history.data is empty %}
									<div class="alert alert-info" role="alert">
										<i class="bi bi-info-circle"></i>
										暂无访问记录。开始浏览书籍后，访问记录将会显示在这里。
									</div>
								{% endif %}
							</div>

							<!-- Popular Books Tab -->
							<div class="tab-pane fade" id="popular-books" role="tabpanel">
								<div class="data-content">
									{% if datasets.popular_books is defined and datasets.popular_books.success and datasets.popular_books.data is not empty %}
										<div class="table-responsive">
											<table class="table table-hover">
												<thead class="table-light">
													<tr>
														<th scope="col">书名</th>
														<th scope="col">访问次数</th>
														<th scope="col">最后访问</th>
														<th scope="col">位置</th>
													</tr>
												</thead>
												<tbody>
													{% for book in datasets.popular_books.data %}
														<tr>
															<td>
																<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																	{{ book.title }}
																</a>
															</td>
															<td>
																{% if book.totalVisits is defined and book.totalVisits %}
																	{{ book.totalVisits|number_format }}
																{% else %}
																	<span class="text-muted">-</span>
																{% endif %}
															</td>
															<td>
																{% if book.lastVisited is defined and book.lastVisited %}
																	<small class="text-muted">
																		<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																	</small>
																{% else %}
																	<small class="text-muted">未访问</small>
																{% endif %}
															</td>
															<td>
																{% if book.location is defined and book.location %}
																	<small class="text-muted">{{ book.location }}</small>
																{% else %}
																	<small class="text-muted">未知位置</small>
																{% endif %}
															</td>
														</tr>
													{% endfor %}
												</tbody>
											</table>
										</div>
									{% else %}
										<div class="text-center py-5">
											<i class="bi bi-star display-4 text-muted"></i>
											<h4 class="mt-3">热门书籍</h4>
											<p class="text-muted">暂无热门书籍数据，开始浏览书籍后数据将会显示在这里。</p>
										</div>
									{% endif %}
								</div>
							</div>

							<!-- Unpopular Books Tab -->
							<div class="tab-pane fade" id="unpopular-books" role="tabpanel">
								{% if datasets.unpopular_books is defined and datasets.unpopular_books.success and datasets.unpopular_books.data is not empty %}
									<div class="table-responsive">
										<table class="table table-hover">
											<thead class="table-light">
												<tr>
													<th scope="col">书名</th>
													<th scope="col">访问次数</th>
													<th scope="col">最后访问</th>
													<th scope="col">位置</th>
												</tr>
											</thead>
											<tbody>
												{% for book in datasets.unpopular_books.data %}
													<tr>
														<td>
															<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																{{ book.title }}
															</a>
														</td>
														<td>
															{% if book.totalVisits is defined and book.totalVisits is not null %}
																{{ book.totalVisits|number_format }}
															{% else %}
																<span class="text-muted">0</span>
															{% endif %}
														</td>
														<td>
															{% if book.lastVisited is defined and book.lastVisited is not null %}
																<small class="text-muted">
																	<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																</small>
															{% else %}
																<small class="text-muted">未访问</small>
															{% endif %}
														</td>
														<td>
															{% if book.location is defined and book.location %}
																<small class="text-muted">{{ book.location }}</small>
															{% else %}
																<small class="text-muted">未知位置</small>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-5">
										<i class="bi bi-star-fill display-4 text-muted"></i>
										<h4 class="mt-3">冷门书籍数据</h4>
										<p class="text-muted">暂无冷门书籍数据，开始浏览书籍后数据将会显示在这里。</p>
									</div>
								{% endif %}
							</div>

							<!-- Recently Visited Books Tab -->
							<div class="tab-pane fade" id="recently-visited" role="tabpanel">
								{% if datasets.recently_visited is defined and datasets.recently_visited.success and datasets.recently_visited.data|length > 0 %}
									<div class="mb-3">
										<h6 class="text-muted">
											<i class="bi bi-bookmark-heart"></i>
											最近访问的书籍 ({{ datasets.recently_visited.data|length }} 本)
											{% if datasets.recently_visited.cached %}
												<span class="badge bg-secondary ms-2">缓存数据</span>
											{% endif %}
										</h6>
									</div>
									<div class="table-responsive">
										<table class="table table-hover">
											<thead class="table-light">
												<tr>
													<th scope="col">书名</th>
													<th scope="col">作者</th>
													<th scope="col">最后访问时间</th>
													<th scope="col">访问次数</th>
												</tr>
											</thead>
											<tbody>
												{% for book in datasets.recently_visited.data %}
													<tr>
														<td>
															<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																{{ book.title }}
															</a>
														</td>
														<td>
															{% if book.author is defined and book.author %}
																<small class="text-muted">{{ book.author }}</small>
															{% else %}
																<small class="text-muted">未知作者</small>
															{% endif %}
														</td>
														<td>
															{% if book.lastVisited is defined and book.lastVisited is not null %}
																<small class="text-muted">
																	<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																</small>
															{% else %}
																<small class="text-muted">未访问</small>
															{% endif %}
														</td>
														<td>
															{% if book.totalVisits is defined and book.totalVisits is not null %}
																<span class="badge bg-primary">{{ book.totalVisits|number_format }}</span>
															{% else %}
																<span class="text-muted">0</span>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-5">
										<i class="bi bi-bookmark-heart display-4 text-muted"></i>
										<h4 class="mt-3">最近访问的书籍</h4>
										<p class="text-muted">暂无最近访问的书籍数据，开始浏览书籍后数据将会显示在这里。</p>
									</div>
								{% endif %}
							</div>

							<!-- Visit Stats Tab -->
							<div class="tab-pane fade" id="visit-stats" role="tabpanel">
								{% if datasets.forgotten_books is defined and datasets.forgotten_books.success and datasets.forgotten_books.data is not empty %}
									<div class="mb-3">
										<h6 class="text-muted">
											<i class="bi bi-graph-up"></i>
											被遗忘的书籍 ({{ datasets.forgotten_books.data|length }} 本)
										</h6>
									</div>
									<div class="table-responsive">
										<table class="table table-hover">
											<thead class="table-light">
												<tr>
													<th scope="col">书名</th>
													<th scope="col">作者</th>
													<th scope="col">最后访问时间</th>
													<th scope="col">天数</th>
													<th scope="col">位置</th>
												</tr>
											</thead>
											<tbody>
												{% for book in datasets.forgotten_books.data %}
													<tr>
														<td>
															<a href="{{ path('book_details', {'bookId': book.bookid}) }}" class="text-decoration-none fw-medium">
																{{ book.title }}
															</a>
														</td>
														<td>
															{% if book.author is defined and book.author %}
																<small class="text-muted">{{ book.author }}</small>
															{% else %}
																<small class="text-muted">未知作者</small>
															{% endif %}
														</td>
														<td>
															{% if book.lastVisited is defined and book.lastVisited is not null %}
																<small class="text-muted">
																	<i class="bi bi-clock"></i> {{ book.lastVisited|date('Y-m-d H:i') }}
																</small>
															{% else %}
																<small class="text-muted">从未访问</small>
															{% endif %}
														</td>
														<td>
															{% if book.daysSinceVisit is defined and book.daysSinceVisit is not null %}
																<span class="text-muted">{{ book.daysSinceVisit }} 天</span>
															{% else %}
																<span class="text-muted">-</span>
															{% endif %}
														</td>
														<td>
															{% if book.location is defined and book.location %}
																<small class="text-muted">{{ book.location }}</small>
															{% else %}
																<small class="text-muted">未知位置</small>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-5">
										<i class="bi bi-graph-up display-4 text-muted"></i>
										<h4 class="mt-3">被遗忘的书籍</h4>
										<p class="text-muted">暂无被遗忘的书籍数据，或者所有书籍都有最近的访问记录。</p>
									</div>
								{% endif %}
							</div>
						{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}